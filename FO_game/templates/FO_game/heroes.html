{% extends "FO_game/base.html" %}
{% block content %}
<h1 class="mb-3">Heroes</h1>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}
{% if saved %}
  <div class="alert alert-success">Squad saved.</div>
{% endif %}

<div class="row g-4">
  <!-- Squad Builder -->
  <div class="col-12 col-lg-5">
    <div class="card bg-dark border-secondary mb-3">
      <div class="card-header">
        <strong>Squad Builder</strong>
        <span class="text-muted ms-2">(Click a slot, then click a hero)</span>
      </div>

      <div class="card-body">
        <div class="small text-muted mb-3">
          Prototype rules: pick up to <strong>5</strong> total units for now.
          (Front/Mid/Back is now <strong>3/3/3</strong>.)
        </div>

        <form method="post" id="squadForm">
          {% csrf_token %}
          <input type="hidden" name="squad_json" id="squad_json" value="" />

          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-sm btn-outline-light" id="clearActiveBtn" disabled>
              Clear selected
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" id="clearAllBtn">
              Clear all
            </button>
            <button type="submit" class="btn btn-sm btn-primary ms-auto">
              Save Squad
            </button>
          </div>

          <div class="small text-muted mb-2" id="hint">Select a slot.</div>

          <!-- Front -->
          <h6 class="text-info mb-2">Front (3 slots)</h6>
          <div class="row g-2 mb-3">
            {% for i in "012" %}
              <div class="col-4">
                <div class="slot border border-secondary rounded p-2 text-center"
                     data-row="front"
                     data-idx="{{ forloop.counter0 }}">
                  <div class="text-muted small">Front {{ forloop.counter }}</div>
                  <div class="slot-name fw-bold">Empty</div>
                  <div class="slot-sub small text-muted">&nbsp;</div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Mid -->
          <h6 class="text-primary mb-2">Mid (3 slots)</h6>
          <div class="row g-2 mb-3">
            {% for i in "012" %}
              <div class="col-4">
                <div class="slot border border-secondary rounded p-2 text-center"
                     data-row="mid"
                     data-idx="{{ forloop.counter0 }}">
                  <div class="text-muted small">Mid {{ forloop.counter }}</div>
                  <div class="slot-name fw-bold">Empty</div>
                  <div class="slot-sub small text-muted">&nbsp;</div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Back -->
          <h6 class="text-warning mb-2">Back (3 slots)</h6>
          <div class="row g-2">
            {% for i in "012" %}
              <div class="col-4">
                <div class="slot border border-secondary rounded p-2 text-center"
                     data-row="back"
                     data-idx="{{ forloop.counter0 }}">
                  <div class="text-muted small">Back {{ forloop.counter }}</div>
                  <div class="slot-name fw-bold">Empty</div>
                  <div class="slot-sub small text-muted">&nbsp;</div>
                </div>
              </div>
            {% endfor %}
          </div>
        </form>
      </div>
    </div>

    {% if current_units %}
      <div class="card bg-dark border-secondary">
        <div class="card-header"><strong>Currently Saved Squad</strong></div>
        <div class="card-body small">
          <div class="mb-2">
            <div class="text-info fw-bold">Front</div>
            <div>
              {% for h in current_units.front %}
                {% if h %}{{ h.hero_base.name }} (Lv {{ h.level }}){% else %}<span class="text-muted">Empty</span>{% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="mb-2">
            <div class="text-primary fw-bold">Mid</div>
            <div>
              {% for h in current_units.mid %}
                {% if h %}{{ h.hero_base.name }} (Lv {{ h.level }}){% else %}<span class="text-muted">Empty</span>{% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          </div>

          <div>
            <div class="text-warning fw-bold">Back</div>
            <div>
              {% for h in current_units.back %}
                {% if h %}{{ h.hero_base.name }} (Lv {{ h.level }}){% else %}<span class="text-muted">Empty</span>{% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Barracks -->
  <div class="col-12 col-lg-7">
    <div class="card bg-dark border-secondary">
      <div class="card-header d-flex justify-content-between align-items-center gap-2">
        <div>
          <strong>Barracks</strong>
          <span class="text-muted ms-2">({{ roster|length }} owned)</span>
        </div>

        <input id="heroSearch"
               class="form-control form-control-sm bg-dark text-light border-secondary"
               style="max-width: 260px;"
               placeholder="Search name/faction/rarity/role..." />
      </div>

      <div class="card-body">
        {% if roster %}
          <div class="row g-3" id="barracksGrid">
            {% for inst in roster %}
              <div class="col-12 col-sm-6 hero-col">
                <div class="hero-card card bg-secondary border-0 h-100"
                     role="button"
                     tabindex="0"
                     data-hero-id="{{ inst.id }}"
                     data-hero-name="{{ inst.hero_base.name|escape }}"
                     data-hero-level="{{ inst.level }}"
                     data-hero-faction="{{ inst.hero_base.faction|escape }}"
                     data-hero-rarity="{{ inst.hero_base.rarity|escape }}"
                     data-hero-role="{{ inst.hero_base.role|escape }}"
                     data-hero-size="{{ inst.hero_base.size|default:'Normal'|escape }}">
                  <div class="card-body p-2 d-flex flex-column">
                    <div class="fw-bold small d-flex justify-content-between align-items-center">
                      <span>
                        {{ inst.hero_base.name }}
                        <span class="text-warning">Lv. {{ inst.level }}</span>
                      </span>
                      <span class="badge bg-dark slot-badge">#{{ inst.id }}</span>
                    </div>

                    <div class="small text-muted">
                      {{ inst.hero_base.faction }} · {{ inst.hero_base.rarity }} · {{ inst.hero_base.role }}
                      {% if inst.hero_base.size %}· {{ inst.hero_base.size }}{% endif %}
                    </div>

                    <div class="mt-2 small">
                      <div>HP: {{ inst.hero_base.base_hp }}</div>
                      <div>ATK: {{ inst.hero_base.base_atk }} · DEF: {{ inst.hero_base.base_def }}</div>
                      <div>M.ATK: {{ inst.hero_base.base_matk }} · M.DEF: {{ inst.hero_base.base_mdef }}</div>
                      <div>SPD: {{ inst.hero_base.base_speed }}</div>
                    </div>

                    <div class="mt-auto pt-2 small text-dark" style="opacity:.7;">
                      Click to assign to selected slot
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">
            You do not own any heroes yet. Go to <a href="{% url 'summon' %}">Summon</a>.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ✅ SAFE JSON for JS (no `None` crash) -->
{{ current|default:None|json_script:"currentSquadData" }}

<style>
  .slot { cursor: pointer; user-select: none; min-height: 74px; }
  .slot:hover { background: rgba(255,255,255,.05); }
  .slot.active { outline: 2px solid rgba(255,255,255,.55); box-shadow: 0 0 0 3px rgba(255,255,255,.10); }
  .slot.filled { background: rgba(255,255,255,.06); }
  .slot.occupied { border-color: rgba(255,210,122,0.35) !important; background: rgba(255,210,122,0.06) !important; }
  .hero-card { cursor: pointer; user-select: none; transition: transform .06s ease, box-shadow .06s ease; }
  .hero-card:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,.25); }
  .hero-card.assigned { opacity: .55; }
</style>

<script>
(() => {
  const ROWS = ["front", "mid", "back"];
  const COLS = 3;

  const slots = Array.from(document.querySelectorAll(".slot"));
  const heroCards = Array.from(document.querySelectorAll(".hero-card"));
  const heroCols = Array.from(document.querySelectorAll(".hero-col"));
  const hint = document.getElementById("hint");
  const squadJsonEl = document.getElementById("squad_json");
  const clearActiveBtn = document.getElementById("clearActiveBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const form = document.getElementById("squadForm");
  const heroSearch = document.getElementById("heroSearch");

  // Load current squad safely
  let initial = null;
  try {
    const el = document.getElementById("currentSquadData");
    initial = el ? JSON.parse(el.textContent) : null;
  } catch (e) {
    initial = null;
  }

  // Grid encoding:
  //  +id = anchor
  //  -id = occupied (non-anchor)
  //  null = empty
  const squad = {
    front: Array(COLS).fill(null),
    mid:   Array(COLS).fill(null),
    back:  Array(COLS).fill(null),
  };

  function clampRow(rowArr) {
    const out = Array(COLS).fill(null);
    (rowArr || []).slice(0, COLS).forEach((v, i) => {
      if (v === "" || v === "0" || v === 0) out[i] = null;
      else out[i] = (v == null ? null : Number(v));
    });
    return out;
  }

  // Backward compat:
  // - If old data had 6 slots, we just take first 3
  // - If old data had no mid, start empty
  if (initial) {
    if (initial.front) squad.front = clampRow(initial.front);
    if (initial.mid)   squad.mid   = clampRow(initial.mid);
    if (initial.back)  squad.back  = clampRow(initial.back);
  }

  let active = { row: "front", idx: 0 };

  function setActive(row, idx) {
    active = { row, idx };
    slots.forEach(s => s.classList.remove("active"));
    const el = slots.find(s => s.dataset.row === row && Number(s.dataset.idx) === idx);
    if (el) el.classList.add("active");
    clearActiveBtn.disabled = false;
    hint.textContent = `Selected: ${row.toUpperCase()} ${idx+1}. Click a hero to assign.`;
  }

  function heroSize(heroId) {
    const card = heroCards.find(c => Number(c.dataset.heroId) === Number(heroId));
    const size = (card?.dataset?.heroSize || "Normal").trim();
    return size || "Normal";
  }

  function footprint(size) {
    // top-left anchor; "down" means towards back (front->mid->back)
    if (size === "Huge")  return { w: 2, h: 2 };
    if (size === "Large") return { w: 1, h: 2 };
    return { w: 1, h: 1 };
  }

  function rowIndex(row) {
    return ROWS.indexOf(row);
  }

  function getCell(row, col) {
    return squad[row][col];
  }

  function setCell(row, col, val) {
    squad[row][col] = val;
  }

  function cellsForAnchor(anchorRow, anchorCol, size) {
    const { w, h } = footprint(size);
    const r0 = rowIndex(anchorRow);
    const out = [];
    for (let dy = 0; dy < h; dy++) {
      for (let dx = 0; dx < w; dx++) {
        const r = r0 + dy;
        const c = anchorCol + dx;
        out.push({ r, c });
      }
    }
    return out;
  }

  function inBounds(r, c) {
    return r >= 0 && r < ROWS.length && c >= 0 && c < COLS;
  }

  function clearHeroEverywhere(heroId) {
    heroId = Number(heroId);
    for (const row of ROWS) {
      for (let c = 0; c < COLS; c++) {
        const v = getCell(row, c);
        if (v === heroId || v === -heroId) setCell(row, c, null);
      }
    }
  }

  function clearSlot(row, idx) {
    const v = getCell(row, idx);
    if (!v) return;
    const heroId = Math.abs(Number(v));
    clearHeroEverywhere(heroId);
    render();
  }

  function clearActive() {
    if (!active) return;
    clearSlot(active.row, active.idx);
  }

  function clearAll() {
    for (const row of ROWS) squad[row] = Array(COLS).fill(null);
    render();
  }

  function canPlace(heroId, anchorRow, anchorCol) {
    heroId = Number(heroId);
    const size = heroSize(heroId);
    const cells = cellsForAnchor(anchorRow, anchorCol, size);

    for (const cell of cells) {
      if (!inBounds(cell.r, cell.c)) return { ok: false, reason: `${size} doesn't fit there.` };
    }

    for (const cell of cells) {
      const rowName = ROWS[cell.r];
      const v = getCell(rowName, cell.c);
      if (v == null) continue;
      const existingId = Math.abs(Number(v));
      if (existingId !== heroId) return { ok: false, reason: `Space is already occupied.` };
    }

    return { ok: true, reason: "" };
  }

  function stampPlacement(heroId, anchorRow, anchorCol) {
    heroId = Number(heroId);
    const size = heroSize(heroId);
    const cells = cellsForAnchor(anchorRow, anchorCol, size);

    clearHeroEverywhere(heroId);

    setCell(anchorRow, anchorCol, heroId);

    const r0 = rowIndex(anchorRow);
    for (const cell of cells) {
      const rowName = ROWS[cell.r];
      const isAnchor = (cell.r === r0 && cell.c === anchorCol);
      if (!isAnchor) setCell(rowName, cell.c, -heroId);
    }
  }

  function assign(heroId) {
    if (!active) return;
    heroId = Number(heroId);

    const existing = getCell(active.row, active.idx);
    if (existing === heroId) {
      clearHeroEverywhere(heroId);
      render();
      return;
    }

    const cur = getCell(active.row, active.idx);
    if (cur) clearHeroEverywhere(Math.abs(Number(cur)));

    const check = canPlace(heroId, active.row, active.idx);
    if (!check.ok) {
      hint.textContent = `Can't place: ${check.reason}`;
      return;
    }

    stampPlacement(heroId, active.row, active.idx);
    render();
  }

  function refreshAssignedStyling() {
    const loc = new Map();
    const letter = { front: "F", mid: "M", back: "B" };

    for (const row of ROWS) {
      for (let c = 0; c < COLS; c++) {
        const v = getCell(row, c);
        if (v && v > 0) loc.set(Number(v), `${letter[row]}${c+1}`);
      }
    }

    heroCards.forEach(card => {
      const id = Number(card.dataset.heroId);
      const where = loc.get(id);
      card.classList.toggle("assigned", !!where);
      const badge = card.querySelector(".slot-badge");
      if (badge) badge.textContent = where ? where : `#${id}`;
    });
  }

  function render() {
    slots.forEach(slot => {
      const row = slot.dataset.row;
      const idx = Number(slot.dataset.idx);
      const v = getCell(row, idx);

      const nameEl = slot.querySelector(".slot-name");
      const subEl = slot.querySelector(".slot-sub");

      slot.classList.remove("filled", "occupied");
      slot.dataset.occupant = "";

      if (!v) {
        nameEl.textContent = "Empty";
        subEl.innerHTML = "&nbsp;";
        return;
      }

      const heroId = Math.abs(Number(v));
      const card = heroCards.find(c => Number(c.dataset.heroId) === heroId);

      if (v < 0) {
        slot.classList.add("occupied");
        slot.dataset.occupant = String(heroId);
        nameEl.textContent = "Occupied";
        subEl.textContent = card ? card.dataset.heroName : `#${heroId}`;
        return;
      }

      slot.classList.add("filled");
      if (card) {
        nameEl.textContent = `${card.dataset.heroName} (Lv ${card.dataset.heroLevel})`;
        const size = (card.dataset.heroSize || "Normal");
        subEl.textContent = `${card.dataset.heroFaction} · ${card.dataset.heroRarity} · ${size}`;
      } else {
        nameEl.textContent = `#${heroId}`;
        subEl.textContent = "";
      }
    });

    squadJsonEl.value = JSON.stringify(squad);
    refreshAssignedStyling();
  }

  slots.forEach(slot => {
    slot.addEventListener("click", () => {
      setActive(slot.dataset.row, Number(slot.dataset.idx));
    });
  });

  heroCards.forEach(card => {
    card.addEventListener("click", () => assign(card.dataset.heroId));
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); card.click(); }
    });
  });

  clearActiveBtn.addEventListener("click", clearActive);
  clearAllBtn.addEventListener("click", clearAll);

  if (heroSearch) {
    heroSearch.addEventListener("input", () => {
      const q = heroSearch.value.trim().toLowerCase();
      heroCols.forEach(col => {
        const card = col.querySelector(".hero-card");
        const hay = (
          (card.dataset.heroName || "") + " " +
          (card.dataset.heroFaction || "") + " " +
          (card.dataset.heroRarity || "") + " " +
          (card.dataset.heroRole || "") + " " +
          (card.dataset.heroSize || "")
        ).toLowerCase();
        col.style.display = hay.includes(q) ? "" : "none";
      });
    });
  }

  render();
  setActive("front", 0);
})();
</script>

{% endblock %}
