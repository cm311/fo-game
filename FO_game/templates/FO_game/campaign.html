{% extends "FO_game/base.html" %}

{% block content %}
  <h1 class="mb-3">Campaign</h1>

  {% if not profile %}
    <p>No profile found. Create a user or log in.</p>
  {% else %}
    {% if need_squad %}
      <div class="alert alert-info">
        No squad selected yet. Go to <a href="{% url 'heroes' %}">Heroes</a> and save a squad.
      </div>
    {% endif %}

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card bg-dark border-secondary mb-3">
      <div class="card-body">
        <button id="startBattleBtn" class="btn btn-primary btn-sm">Start Battle</button>
        <button id="stepBtn" class="btn btn-outline-light btn-sm ms-2" disabled>Step</button>
        <span id="phaseLabel" class="ms-3 text-muted small"></span>
        <span id="turnLabel" class="ms-3 text-warning small"></span>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <h5 class="text-danger">Enemy</h5>
        <div class="small text-muted mb-1">Front</div>
        <div id="enemyFront" class="d-flex gap-2 flex-wrap mb-2"></div>

        <div class="small text-muted mb-1">Mid</div>
        <div id="enemyMid" class="d-flex gap-2 flex-wrap mb-2"></div>

        <div class="small text-muted mb-1">Back</div>
        <div id="enemyBack" class="d-flex gap-2 flex-wrap"></div>
      </div>

      <div class="col-12 mt-3">
        <h5 class="text-info">Your Team</h5>
        <div class="small text-muted mb-1">Front</div>
        <div id="playerFront" class="d-flex gap-2 flex-wrap mb-2"></div>

        <div class="small text-muted mb-1">Mid</div>
        <div id="playerMid" class="d-flex gap-2 flex-wrap mb-2"></div>

        <div class="small text-muted mb-1">Back</div>
        <div id="playerBack" class="d-flex gap-2 flex-wrap"></div>
      </div>

      <div class="col-12 mt-3">
        <h5>Combat Log</h5>
        <div id="logBox" style="max-height: 300px; overflow:auto; border:1px solid #333; padding:8px;"></div>
      </div>
    </div>

    <form style="display:none">
      {% csrf_token %}
    </form>

    <script>
    (function(){
      const startBtn = document.getElementById("startBattleBtn");
      const stepBtn = document.getElementById("stepBtn");
      const phaseLabel = document.getElementById("phaseLabel");
      const turnLabel = document.getElementById("turnLabel");

      const enemyFront = document.getElementById("enemyFront");
      const enemyMid   = document.getElementById("enemyMid");
      const enemyBack  = document.getElementById("enemyBack");

      const playerFront = document.getElementById("playerFront");
      const playerMid   = document.getElementById("playerMid");
      const playerBack  = document.getElementById("playerBack");

      const logBox = document.getElementById("logBox");

      let lastSnapshot = null;

      function csrf() {
        const el = document.querySelector("input[name=csrfmiddlewaretoken]");
        return el ? el.value : "";
      }

      async function post(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrf()
          },
          body: body ? JSON.stringify(body) : "{}"
        });

        const text = await res.text();
        try {
          const data = JSON.parse(text);
          if (!res.ok && !data.error) data.error = `HTTP ${res.status}`;
          return data;
        } catch (e) {
          return { ok: false, error: `HTTP ${res.status}: ${text.slice(0, 200)}` };
        }
      }

      function rowHasAlive(units) {
        return (units || []).some(u => (u.hp ?? 0) > 0);
      }

      function enemyBackTargetable(snapshot) {
        // Back is NOT targetable only when BOTH front and mid have at least one alive unit.
        const frontAlive = rowHasAlive(snapshot.enemy.front);
        const midAlive   = rowHasAlive(snapshot.enemy.mid);
        return (!frontAlive) || (!midAlive);
      }

      function unitCard(u, side, isTargetable=true) {
        const div = document.createElement("div");
        div.className = "p-2 border rounded";
        div.style.minWidth = "170px";
        div.style.userSelect = "none";
        div.dataset.side = side;
        div.dataset.row = u.row;
        div.dataset.slot = u.slot;

        const hpPct = u.max_hp ? Math.max(0, Math.floor((u.hp / u.max_hp) * 100)) : 0;

        // styling
        div.style.background = "rgba(255,255,255,.03)";
        div.style.borderColor = "rgba(255,255,255,.18)";

        if (side === "enemy") {
          div.style.cursor = isTargetable ? "pointer" : "not-allowed";
          if (!isTargetable) {
            div.style.opacity = "0.35";
            div.title = "Back row is protected (not targetable) while Front + Mid are alive.";
          }
        }

        div.innerHTML = `
          <div class="fw-bold">${u.name} <span class="text-muted">Lv ${u.level}</span></div>
          <div class="small text-muted">${u.row.toUpperCase()} slot ${u.slot+1}</div>
          <div class="small">HP: ${u.hp}/${u.max_hp} (${hpPct}%)</div>
          <div class="small">AP: ${u.ap} / 100</div>
          <div class="progress mt-1" style="height:6px;">
            <div class="progress-bar bg-warning" style="width:${Math.min(100, u.ap)}%"></div>
          </div>
        `;
        return div;
      }

      function fill(container, units, side, snapshot, rowName) {
        container.innerHTML = "";

        const backOk = (side !== "enemy") ? true : enemyBackTargetable(snapshot);

        (units || []).forEach(u => {
          // determine targetability for this unit
          let isTargetable = true;
          if (side === "enemy" && rowName === "back") {
            isTargetable = backOk;
          }

          const c = unitCard(u, side, isTargetable);

          // Enemy targets clickable ONLY when player is paused
          if (side === "enemy") {
            c.addEventListener("click", async () => {
              if (!lastSnapshot || lastSnapshot.phase !== "PLAYER_PAUSE") return;
              if (!isTargetable) return;

              const data = await post("{% url 'api-battle-act' %}", {
                target_side: "enemy",
                target_row: u.row,
                target_slot: u.slot
              });

              if (data.ok) render(data.snapshot);
              else alert(data.error || "act failed");
            });
          }

          container.appendChild(c);
        });
      }

      function render(snapshot) {
        lastSnapshot = snapshot;

        phaseLabel.textContent =
          `Tick ${snapshot.tick}/${snapshot.tick_limit} — ${snapshot.phase}` +
          (snapshot.winner ? ` — Winner: ${snapshot.winner}` : "");

        // Turn label: in this engine, pause phase is PLAYER_PAUSE
        if (snapshot.phase === "PLAYER_PAUSE") {
          turnLabel.textContent = "YOUR TURN: click an enemy target";
        } else {
          turnLabel.textContent = "";
        }

        fill(enemyFront, snapshot.enemy.front, "enemy", snapshot, "front");
        fill(enemyMid,   snapshot.enemy.mid,   "enemy", snapshot, "mid");
        fill(enemyBack,  snapshot.enemy.back,  "enemy", snapshot, "back");

        fill(playerFront, snapshot.player.front, "player", snapshot, "front");
        fill(playerMid,   snapshot.player.mid,   "player", snapshot, "mid");
        fill(playerBack,  snapshot.player.back,  "player", snapshot, "back");

        // Step is enabled only while running
        stepBtn.disabled = snapshot.phase !== "RUNNING";

        // log
        logBox.innerHTML = "";
        (snapshot.log || []).forEach(e => {
          const line = document.createElement("div");
          line.innerHTML =
            `<small>[${e.tick}]</small> <strong>${e.type}</strong> ${e.source || ""} ${e.target ? "→ " + e.target : ""} ${e.value ? "(" + e.value + ")" : ""}`;
          logBox.appendChild(line);
        });
        logBox.scrollTop = logBox.scrollHeight;
      }

      startBtn.addEventListener("click", async () => {
        const data = await post("{% url 'api-battle-start' %}", {});
        if (data.ok) render(data.snapshot);
        else alert(data.error || "start failed");
      });

      stepBtn.addEventListener("click", async () => {
        const data = await post("{% url 'api-battle-step' %}", {});
        if (data.ok) render(data.snapshot);
        else alert(data.error || "step failed");
      });
    })();
    </script>

    {% if battle %}
      {% if battle.summary %}
        <h3>Squads</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="p-3 border rounded mb-3">
              <h5 class="mb-2">Your Squad</h5>
              <!-- old summary fields kept for legacy; your run_battle() summary is now different -->
              <div class="text-muted small">See the live battle UI above for the real rows.</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded mb-3">
              <h5 class="mb-2">Enemy Squad</h5>
              <div class="text-muted small">See the live battle UI above for the real rows.</div>
            </div>
          </div>
        </div>
      {% endif %}

      <h2 class="mt-2">Result: {{ battle.winner|title }}</h2>

      {% if battle.highlights %}
        <h4 class="mt-3">Highlights</h4>
        <ul>
          {% for h in battle.highlights %}
            <li>{{ h }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if xp_results %}
        <h3 class="mt-4">XP Gained</h3>
        <ul>
          {% for hid, info in xp_results.items %}
            <li>
              #{{ hid }}: +{{ info.gained }} XP —
              Level {{ info.new_level }}
              {% if info.leveled %}(+{{ info.leveled }}){% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      <details class="mt-4">
        <summary class="text-info">Show full battle log</summary>
        <div style="max-height: 420px; overflow:auto; border:1px solid #333; padding:8px;" class="mt-2">
          {% for e in battle.log %}
            <div>
              <small>[{{ e.tick }}]</small>
              <strong>{{ e.type }}</strong>
              {% if e.source %} {{ e.source }}{% endif %}
              {% if e.target %} → {{ e.target }}{% endif %}
              {% if e.value %} ({{ e.value }}){% endif %}
            </div>
          {% endfor %}
        </div>
      </details>

    {% else %}
      <p class="text-muted mt-3">No battle run yet. Summon at least 1 hero.</p>
    {% endif %}
  {% endif %}
{% endblock %}
